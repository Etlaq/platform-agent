'use client'

import { useState, useEffect } from 'react'
import { ShoppingBag, Search, Menu, X, Globe } from 'lucide-react'
import { useLanguage } from '@/contexts/LanguageContext'
import { useCart } from '@/contexts/CartContext'
import { cn } from '@/lib/utils'
import { CartDrawer } from '@/components/CartDrawer'

const NAV_KEYS = ['nav.home', 'nav.shop', 'nav.categories', 'nav.about'] as const

export function Header() {
  const { language, isArabic, setLanguage, t } = useLanguage()
  const { totalItems, setIsCartOpen } = useCart()
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false)
  const [scrolled, setScrolled] = useState(false)

  /* ── Scroll detection — adds shadow after 10px ── */
  useEffect(() => {
    const handleScroll = () => setScrolled(window.scrollY > 10)
    window.addEventListener('scroll', handleScroll, { passive: true })
    return () => window.removeEventListener('scroll', handleScroll)
  }, [])

  /* ── Lock body scroll when mobile menu is open ── */
  useEffect(() => {
    if (mobileMenuOpen) {
      document.body.style.overflow = 'hidden'
    } else {
      document.body.style.overflow = ''
    }
    return () => {
      document.body.style.overflow = ''
    }
  }, [mobileMenuOpen])

  const toggleLanguage = () => {
    setLanguage(language === 'ar' ? 'en' : 'ar')
  }

  return (
    <>
      <header
        className={cn(
          'sticky top-0 z-30 w-full border-b border-sand-200 bg-cream/90 backdrop-blur-md transition-shadow duration-300',
          scrolled && 'shadow-lg shadow-espresso-900/5'
        )}
      >
        {/* ═══ Top accent bar — liquid gold ribbon ═══ */}
        <div className="h-0.5 w-full bg-gradient-to-r from-amber-deep via-amber-gold to-amber-warm" />

        {/* ═══ Inner container ═══ */}
        <div className="mx-auto flex h-16 max-w-7xl items-center justify-between px-4 sm:h-20 sm:px-6 lg:px-8">

          {/* ── Start: Brand ─────────────────────────────── */}
          <a href="/" className="group flex items-center gap-2.5">
            {/* Palm tree icon in espresso circle with gold stroke */}
            <span className="relative flex h-9 w-9 items-center justify-center rounded-full bg-espresso-900 transition-transform duration-300 group-hover:scale-110 sm:h-10 sm:w-10">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                className="h-5 w-5 text-amber-gold sm:h-[22px] sm:w-[22px]"
                stroke="currentColor"
                strokeWidth="1.5"
                strokeLinecap="round"
                strokeLinejoin="round"
              >
                <path d="M12 22V8" />
                <path d="M12 8c0-3-2-5-5-6 1 2 1.5 4 1 6" />
                <path d="M12 8c0-3 2-5 5-6-1 2-1.5 4-1 6" />
                <path d="M12 12c-2-1-4.5-1-6.5 0" />
                <path d="M12 12c2-1 4.5-1 6.5 0" />
              </svg>
              {/* Subtle gold ring on hover */}
              <span
                className="absolute inset-0 rounded-full ring-2 ring-amber-gold/0 transition-all duration-300 group-hover:ring-amber-gold/40"
                aria-hidden="true"
              />
            </span>

            {/* Brand text */}
            <div className="flex flex-col">
              <span className="font-[family-name:var(--font-display)] text-2xl font-bold leading-none tracking-tight text-espresso-900 sm:text-3xl">
                {isArabic ? 'نخيل' : 'Nakheel'}
              </span>
              <span className="mt-0.5 hidden text-[10px] font-semibold tracking-[0.2em] text-amber-deep uppercase sm:block">
                {isArabic ? 'تمور فاخرة' : 'Premium Dates'}
              </span>
            </div>
          </a>

          {/* ── Center: Desktop Navigation ───────────────── */}
          <nav className="hidden lg:block" aria-label="Main navigation">
            <ul className="flex items-center gap-1">
              {NAV_KEYS.map((key) => (
                <li key={key}>
                  <a
                    href="#"
                    className={cn(
                      'relative flex h-11 items-center rounded-full px-5 text-sm font-medium text-espresso-700 transition-colors duration-200',
                      'hover:bg-sand-100 hover:text-espresso-900'
                    )}
                  >
                    {t(key)}
                    {/* Active indicator — gold bar on home */}
                    {key === 'nav.home' && (
                      <span
                        className="absolute inset-x-4 -bottom-[1.125rem] h-0.5 rounded-full bg-amber-gold sm:-bottom-[1.625rem]"
                        aria-hidden="true"
                      />
                    )}
                  </a>
                </li>
              ))}
            </ul>
          </nav>

          {/* ── End: Actions ─────────────────────────────── */}
          <div className="flex items-center gap-1 sm:gap-2">
            {/* Search */}
            <button
              className="flex h-11 w-11 items-center justify-center rounded-full text-espresso-600 transition-colors duration-200 hover:bg-sand-100 hover:text-espresso-900"
              aria-label={t('nav.search')}
            >
              <Search className="h-5 w-5" strokeWidth={1.75} />
            </button>

            {/* Language toggle — desktop pill */}
            <button
              onClick={toggleLanguage}
              className="hidden h-11 items-center gap-1.5 rounded-full border border-sand-200 pe-4 ps-3.5 text-xs font-semibold text-espresso-700 transition-colors duration-200 hover:border-amber-gold/40 hover:bg-sand-50 sm:flex"
              aria-label={isArabic ? 'Switch to English' : 'التبديل إلى العربية'}
            >
              <Globe className="h-3.5 w-3.5" strokeWidth={1.75} />
              {isArabic ? 'EN' : 'عربي'}
            </button>

            {/* Language toggle — mobile icon only */}
            <button
              onClick={toggleLanguage}
              className="flex h-11 w-11 items-center justify-center rounded-full text-espresso-600 transition-colors duration-200 hover:bg-sand-100 hover:text-espresso-900 sm:hidden"
              aria-label={isArabic ? 'Switch to English' : 'التبديل إلى العربية'}
            >
              <Globe className="h-5 w-5" strokeWidth={1.75} />
            </button>

            {/* Cart */}
            <button
              onClick={() => setIsCartOpen(true)}
              className="relative flex h-11 w-11 items-center justify-center rounded-full text-espresso-600 transition-colors duration-200 hover:bg-sand-100 hover:text-espresso-900"
              aria-label={`${t('nav.cart')}${totalItems > 0 ? ` (${totalItems})` : ''}`}
            >
              <ShoppingBag className="h-5 w-5" strokeWidth={1.75} />
              {totalItems > 0 && (
                <span className="absolute -end-0.5 -top-0.5 flex h-5 min-w-5 items-center justify-center rounded-full bg-amber-gold px-1 text-[10px] font-bold leading-none text-espresso-900 shadow-sm ring-2 ring-cream/90">
                  {totalItems}
                </span>
              )}
            </button>

            {/* Mobile hamburger */}
            <button
              onClick={() => setMobileMenuOpen(true)}
              className="flex h-11 w-11 items-center justify-center rounded-full text-espresso-600 transition-colors duration-200 hover:bg-sand-100 hover:text-espresso-900 lg:hidden"
              aria-label="Open menu"
              aria-expanded={mobileMenuOpen}
            >
              <Menu className="h-5 w-5" strokeWidth={1.75} />
            </button>
          </div>
        </div>
      </header>

      {/* ═══════════════════════════════════════════════════════════════════
           Mobile Menu Drawer
           ═══════════════════════════════════════════════════════════════════ */}

      {/* Backdrop overlay */}
      <div
        className={cn(
          'fixed inset-0 z-40 bg-espresso-900/40 backdrop-blur-sm transition-opacity duration-300 lg:hidden',
          mobileMenuOpen ? 'opacity-100' : 'pointer-events-none opacity-0'
        )}
        onClick={() => setMobileMenuOpen(false)}
        aria-hidden="true"
      />

      {/* Slide-in panel — RTL-aware */}
      <div
        className={cn(
          'fixed inset-y-0 end-0 z-50 flex w-full max-w-xs flex-col bg-cream shadow-dramatic transition-transform duration-300 ease-out lg:hidden',
          mobileMenuOpen
            ? 'translate-x-0'
            : 'ltr:translate-x-full rtl:-translate-x-full'
        )}
        role="dialog"
        aria-modal="true"
        aria-label="Mobile navigation"
      >
        {/* ── Drawer header ── */}
        <div className="flex items-center justify-between border-b border-sand-200 px-6 py-5">
          <div className="flex items-center gap-2">
            {/* Mini palm icon */}
            <span className="flex h-7 w-7 items-center justify-center rounded-full bg-espresso-900">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                className="h-4 w-4 text-amber-gold"
                stroke="currentColor"
                strokeWidth="1.5"
                strokeLinecap="round"
                strokeLinejoin="round"
              >
                <path d="M12 22V8" />
                <path d="M12 8c0-3-2-5-5-6 1 2 1.5 4 1 6" />
                <path d="M12 8c0-3 2-5 5-6-1 2-1.5 4-1 6" />
                <path d="M12 12c-2-1-4.5-1-6.5 0" />
                <path d="M12 12c2-1 4.5-1 6.5 0" />
              </svg>
            </span>
            <span className="font-[family-name:var(--font-display)] text-xl font-bold text-espresso-900">
              {isArabic ? 'نخيل' : 'Nakheel'}
            </span>
          </div>
          <button
            onClick={() => setMobileMenuOpen(false)}
            className="flex h-11 w-11 items-center justify-center rounded-full text-espresso-600 transition-colors duration-200 hover:bg-sand-100 hover:text-espresso-900"
            aria-label="Close menu"
          >
            <X className="h-5 w-5" strokeWidth={1.75} />
          </button>
        </div>

        {/* ── Navigation links ── */}
        <nav className="flex-1 overflow-y-auto px-4 py-6" aria-label="Mobile navigation">
          <ul className="flex flex-col gap-1">
            {NAV_KEYS.map((key) => (
              <li key={key}>
                <a
                  href="#"
                  onClick={() => setMobileMenuOpen(false)}
                  className={cn(
                    'flex h-12 items-center rounded-xl px-4 text-base font-medium text-espresso-700 transition-colors duration-200',
                    'hover:bg-sand-100 hover:text-espresso-900',
                    key === 'nav.home' && 'bg-sand-50 text-espresso-900'
                  )}
                >
                  {t(key)}
                  {key === 'nav.home' && (
                    <span
                      className="ms-auto h-1.5 w-1.5 rounded-full bg-amber-gold"
                      aria-hidden="true"
                    />
                  )}
                </a>
              </li>
            ))}
          </ul>

          {/* Divider */}
          <div className="my-6 h-px bg-gradient-to-r from-transparent via-sand-300 to-transparent" />

          {/* Language switch */}
          <button
            onClick={() => {
              toggleLanguage()
              setMobileMenuOpen(false)
            }}
            className="flex h-12 w-full items-center gap-3 rounded-xl px-4 text-base font-medium text-espresso-700 transition-colors duration-200 hover:bg-sand-100 hover:text-espresso-900"
          >
            <Globe className="h-5 w-5 text-amber-deep" strokeWidth={1.75} />
            {isArabic ? 'English' : 'العربية'}
          </button>
        </nav>

        {/* ── Drawer footer ── */}
        <div className="border-t border-sand-200 px-6 py-5">
          <p className="text-center text-xs text-espresso-500">
            {isArabic ? '© ٢٠٢٤ نخيل — تمور فاخرة' : '© 2024 Nakheel — Premium Dates'}
          </p>
        </div>
      </div>

      {/* ═══ Cart Drawer ═══ */}
      <CartDrawer />
    </>
  )
}
